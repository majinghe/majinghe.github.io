<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>ä½¿ç”¨ cosign æ¥ç­¾åå’ŒéªŒè¯ OCI é•œåƒï¼Œå¹¶å’Œ Tekton CI/CD é›†æˆ - å°é©¬å“¥çš„åšå®¢</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="é©¬æ™¯è´ºï¼ˆå°é©¬å“¥ï¼‰"><meta name=description content="cosign ç”¨æ¥å¯¹ OCI è¿›è¡Œç­¾åå’ŒéªŒè¯ï¼Œä»è€Œä¿è¯é•œåƒçš„å®‰å…¨ï¼ŒåŒæ—¶å’Œ CI/CD é›†æˆï¼Œæ‰“é€  DevSecOpsã€‚"><meta name=keywords content="Hugo,theme,even"><meta name=generator content="Hugo 0.79.1 with theme even"><link rel=canonical href=https://majinghe.github.io/devsecops/cosign/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.c7bc1becf36bcf6a9ebd25d2947e43a2eb745ddb0c9a32b43126fd7fa460c351.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="ä½¿ç”¨ cosign æ¥ç­¾åå’ŒéªŒè¯ OCI é•œåƒï¼Œå¹¶å’Œ Tekton CI/CD é›†æˆ"><meta property="og:description" content="cosign ç”¨æ¥å¯¹ OCI è¿›è¡Œç­¾åå’ŒéªŒè¯ï¼Œä»è€Œä¿è¯é•œåƒçš„å®‰å…¨ï¼ŒåŒæ—¶å’Œ CI/CD é›†æˆï¼Œæ‰“é€  DevSecOpsã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://majinghe.github.io/devsecops/cosign/"><meta property="article:published_time" content="2022-05-06T13:05:42+08:00"><meta property="article:modified_time" content="2022-05-06T13:05:42+08:00"><meta itemprop=name content="ä½¿ç”¨ cosign æ¥ç­¾åå’ŒéªŒè¯ OCI é•œåƒï¼Œå¹¶å’Œ Tekton CI/CD é›†æˆ"><meta itemprop=description content="cosign ç”¨æ¥å¯¹ OCI è¿›è¡Œç­¾åå’ŒéªŒè¯ï¼Œä»è€Œä¿è¯é•œåƒçš„å®‰å…¨ï¼ŒåŒæ—¶å’Œ CI/CD é›†æˆï¼Œæ‰“é€  DevSecOpsã€‚"><meta itemprop=datePublished content="2022-05-06T13:05:42+08:00"><meta itemprop=dateModified content="2022-05-06T13:05:42+08:00"><meta itemprop=wordCount content="1573"><meta itemprop=keywords content="Security,Image,Cosign,"><meta name=twitter:card content="summary"><meta name=twitter:title content="ä½¿ç”¨ cosign æ¥ç­¾åå’ŒéªŒè¯ OCI é•œåƒï¼Œå¹¶å’Œ Tekton CI/CD é›†æˆ"><meta name=twitter:description content="cosign ç”¨æ¥å¯¹ OCI è¿›è¡Œç­¾åå’ŒéªŒè¯ï¼Œä»è€Œä¿è¯é•œåƒçš„å®‰å…¨ï¼ŒåŒæ—¶å’Œ CI/CD é›†æˆï¼Œæ‰“é€  DevSecOpsã€‚"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>å°é©¬å“¥</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/cloud-native><li class=mobile-menu-item>Cloud Native</li></a><a href=/devsecops><li class=mobile-menu-item>DevSecOps</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><head><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','G-T0B2C6W2ZH','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-T0B2C6W2ZH','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><div class=logo-wrapper><a href=/ class=logo>å°é©¬å“¥</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/cloud-native>Cloud Native</a></li><li class=menu-item><a class=menu-item-link href=/devsecops>DevSecOps</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>ä½¿ç”¨ cosign æ¥ç­¾åå’ŒéªŒè¯ OCI é•œåƒï¼Œå¹¶å’Œ Tekton CI/CD é›†æˆ</h1><div class=post-meta><span class=post-time>2022-05-06</span><div class=post-category><a href=/categories/devsecops/>DevSecOps</a></div><span class=more-meta>çº¦ 1573 å­—</span>
<span class=more-meta>é¢„è®¡é˜…è¯» 4 åˆ†é’Ÿ</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>æ–‡ç« ç›®å½•</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#å…³äº-cosign>å…³äº cosign</a></li><li><a href=#cosign-å®‰è£…>cosign å®‰è£…</a></li><li><a href=#cosign-çš„ä½¿ç”¨>cosign çš„ä½¿ç”¨</a><ul><li><a href=#ç¬¬ä¸€æ­¥ç”Ÿæˆ-keypair>ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆ keypair</a></li><li><a href=#ç¬¬äºŒæ­¥ä½¿ç”¨-private-key-ç­¾åé•œåƒ>ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ private key ç­¾åé•œåƒ</a></li><li><a href=#é•œåƒéªŒè¯>é•œåƒéªŒè¯</a></li><li><a href=#ç¯¡æ”¹é•œåƒåšéªŒè¯>ç¯¡æ”¹é•œåƒåšéªŒè¯</a></li></ul></li><li><a href=#å°†é•œåƒç­¾ååµŒå…¥-tekton-cicd>å°†é•œåƒç­¾ååµŒå…¥ Tekton CI/CD</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=å…³äº-cosign>å…³äº cosign</h2><p>cosign æ˜¯ <code>sigstore</code> é¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œä¸»è¦ç”¨æ¥å¯¹ OCI é•œåƒè¿›è¡Œç­¾åå’ŒéªŒè¯ï¼Œä»è€Œè®©ç­¾åæˆä¸ºä¸€ç§æ— å½¢çš„åŸºç¡€è®¾æ–½ã€‚cosign ç›®å‰æ”¯æŒä»¥ä¸‹å‡ ç§ç­¾åæ–¹å¼ï¼š</p><ul><li>ç¡¬ä»¶å’Œ KMS ç­¾å</li><li>ä½¿ç”¨è‡ªå·±çš„ PKI</li><li>å…è´¹çš„ OIDC PKI</li><li>å†…ç½®çš„äºŒè¿›åˆ¶é€æ˜å’Œæ—¶é—´æˆ³æœåŠ¡</li></ul><h2 id=cosign-å®‰è£…>cosign å®‰è£…</h2><p>cosgin æœ‰å¤šç§å®‰è£…æ–¹å¼ï¼Œè¯¦ç»†å®‰è£…å¯ä»¥æŸ¥çœ‹ <a href=https://github.com/sigstore/cosign>GitHub Repo å®‰è£…æŒ‡å—</a>ï¼Œä»¥ macOS ä¸ºä¾‹ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯å®Œæˆå®‰è£…ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ brew install cosign
</code></pre></td></tr></table></div></div><p>ä½¿ç”¨ <code>version</code> å‘½ä»¤æŸ¥çœ‹å®‰è£…ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ cosign version
GitVersion:    1.4.1
GitCommit:     934567a4c606cf59e6ab17af889b4db3ee0a3f0b
GitTreeState:  &#34;clean&#34;
BuildDate:     2021-12-10T16:54:56Z
GoVersion:     go1.17.3
Compiler:      gc
Platform:      darwin/amd64
</code></pre></td></tr></table></div></div><h2 id=cosign-çš„ä½¿ç”¨>cosign çš„ä½¿ç”¨</h2><p>ä½¿ç”¨ <code>cosgin</code> æ¥å¯¹é•œåƒç­¾åï¼Œä¸€èˆ¬æœ‰ä¸‰æ­¥ï¼š</p><h3 id=ç¬¬ä¸€æ­¥ç”Ÿæˆ-keypair>ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆ keypair</h3><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯å®Œæˆ keypair çš„ç”Ÿæˆï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ cosign generate-key-pair
Enter password for private key:
Enter password for private key again:
Private key written to cosign.key
Public key written to cosign.pub
</code></pre></td></tr></table></div></div><p>æ ¹æ®æç¤ºè¾“å…¥ä¸¤æ¬¡ç”Ÿæˆ private key çš„ password å³å¯ã€‚åœ¨å½“å‰ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¸¤ä¸ªæ–‡ä»¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>-rw-------  1 xiaomage  staff    649 May  6 23:23 cosign.key
-rw-r--r--  1 xiaomage  staff    178 May  6 23:23 cosign.pub
</code></pre></td></tr></table></div></div><p>ä¸¤è€…çš„å†…å®¹å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ cat cosign.pub
-----BEGIN PUBLIC KEY-----
MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAErZce/WXwxFR51Ol07BsVrMGhLOXY
9IHEXkNTwrfsUuIKb/P7hgDewfR9zc55Gvyi9xV7TvzKCuwL17gXN6pcGQ==
-----END PUBLIC KEY-----

$ cat cosign.key
-----BEGIN ENCRYPTED COSIGN PRIVATE KEY-----
eyJrZGYiOnsibmFtZSI6InNjcnlwdCIsInBhcmFtcyI6eyJOIjozMjc2OCwiciI6
OCwicCI6MX0sInNhbHQiOiJ6VkExYy9YcUJnc1JaZEFsbSsxT29zQXNhbFVzSGE5
Uk52VlFUYVk1Z0JvPSJ9LCJjaXBoZXIiOnsibmFtZSI6Im5hY2wvc2VjcmV0Ym94
Iiwibm9uY2UiOiJWTzJ2akkwMUtpREpvWll0MWg4WVpTd0I4ZlVkTTE4bCJ9LCJj
aXBoZXJ0ZXh0IjoiVTAvekhacXdZMThwdzFtL0VIZ1huNzRHanIreDQ3NUVCTGNw
RzAyR3ArVDZpaFFTL3lxYlJwZWtQdDRZWGdyakZPUEgxc2lkN1AxdXFQUmlLZDBa
R2haenByWExTVXo3djI4ZUw3OERJNE1oS2ZjQldxL1VXSG00d3E0TVBIZE5IWm54
WVVmK3FETW1EbW1GOVBkV3NwOVAxK2NQaTUxWGpvMHJMbkI2amNseXpQVnQvcUdz
N2tUclhGSDI0VHZDbng1TDFHcFhrb1Jpc2c9PSJ9
-----END ENCRYPTED COSIGN PRIVATE KEY-----
</code></pre></td></tr></table></div></div><p>å¦‚æœå°† private key æ‰€éœ€çš„ password ä»¥ç¯å¢ƒå˜é‡ <code>COSIGN_PASSWORD</code> çš„å½¢å¼æ³¨å…¥çš„è¯ï¼Œåˆ™å¯ä»¥ä¸ç”¨æ‰‹åŠ¨è¾“å…¥ passwordï¼Œæ•´ä¸ªè¿‡ç¨‹ä¼šè‡ªåŠ¨è¯»å–ç¯å¢ƒå˜é‡å¹¶ä½¿ç”¨ã€‚</p><h3 id=ç¬¬äºŒæ­¥ä½¿ç”¨-private-key-ç­¾åé•œåƒ>ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ private key ç­¾åé•œåƒ</h3><p>ä»¥ <code>dllhb/go-demo:v1.0.0</code> ä¸ºä¾‹æ¥æ¼”ç¤ºï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ¥ç­¾åï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ cosign sign --key cosign.key dllhb/go-demo:v1.0.0
Enter password for private key:
Pushing signature to: index.docker.io/dllhb/go-demo
</code></pre></td></tr></table></div></div><p>å¯ä»¥åœ¨é•œåƒä»“åº“ä¸­çœ‹åˆ°é•œåƒå‘ç”Ÿäº†å¦‚ä¸‹å˜åŒ–ï¼š</p><p><img src=images/cosign-image.png alt=cosign-image></p><h3 id=é•œåƒéªŒè¯>é•œåƒéªŒè¯</h3><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯å¯¹æ‹‰å–çš„é•œåƒè¿›è¡Œç­¾åéªŒè¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ cosign verify --key cosign.pub dllhb/go-demo:v1.0.0 | jq .
Verification for index.docker.io/dllhb/go-demo:v1.0.0 --
The following checks were performed on each of these signatures:
  - The cosign claims were validated
  - The signatures were verified against the specified public key
  - Any certificates were verified against the Fulcio roots.
[
  {
    &#34;critical&#34;: {
      &#34;identity&#34;: {
        &#34;docker-reference&#34;: &#34;index.docker.io/dllhb/go-demo&#34;
      },
      &#34;image&#34;: {
        &#34;docker-manifest-digest&#34;: &#34;sha256:888988496480bb0be8984b43a84970589e41110a2d25440f145031fd396dd2db&#34;
      },
      &#34;type&#34;: &#34;cosign container image signature&#34;
    },
    &#34;optional&#34;: null
  }
]
</code></pre></td></tr></table></div></div><p>è€Œä¸”ä¸Šè¿°å‘½ä»¤è¿”å› <code>0</code> å€¼ã€‚è¿”å›çš„ payload é‡Œé¢æœ‰é•œåƒçš„ digest ä¿¡æ¯ï¼Œå’Œé•œåƒä»“åº“ä¸­å±•ç°çš„ä¸€è‡´ï¼Œè¯´æ˜é•œåƒæ²¡æœ‰è¢«ç¯¡æ”¹ã€‚å¦‚æœè¢«ç¯¡æ”¹äº†ï¼Œé‚£ä¹ˆéªŒè¯ç»“æœæ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p><h3 id=ç¯¡æ”¹é•œåƒåšéªŒè¯>ç¯¡æ”¹é•œåƒåšéªŒè¯</h3><p>æˆ‘ä»¬å°†ä¸Šè¿°é•œåƒåšä¸€ä¸‹ç¯¡æ”¹ï¼ˆä¿®æ”¹é‡Œé¢åº”ç”¨ç¨‹åºçš„å†…å®¹ï¼Œç„¶åä»¥åŒæ ·çš„ tag æ„å»ºå¹¶æ¨é€ä¸Šå»ï¼‰ï¼Œç„¶åç”¨åŒæ ·çš„æ–¹å¼å»éªŒè¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ cosign verify --key cosign.pub dllhb/go-demo:v1.0.0 | jq .
Error: no matching signatures:

main.go:46: error during command execution: no matching signatures:
</code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°æŠ¥é”™äº†ï¼Œæç¤ºæ— æ³•æ‰¾åˆ°ç›¸åŒ¹é…çš„ç­¾åã€‚è¯´æ˜é•œåƒæœ‰è¢«ç¯¡æ”¹è¿‡ï¼Œä¾§é¢åæ˜ äº† cosign æ˜¯å¦‚ä½•é€šè¿‡é•œåƒç­¾åæ¥ä¿è¯é•œåƒå®‰å…¨çš„ã€‚</p><h2 id=å°†é•œåƒç­¾ååµŒå…¥-tekton-cicd>å°†é•œåƒç­¾ååµŒå…¥ Tekton CI/CD</h2><p>åªéœ€è¦åœ¨ Tekton CI/CD ä¸­æ·»åŠ ä¸€ä¸ªé¢å¤–çš„ <code>Step</code> å³å¯å®Œæˆé•œåƒçš„ç­¾åï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>    - name: image-singature-verification
      image: bitnami/cosign:latest
      args:
        - verify
        - --key
        - /tmp/cosign.pub
        - $(resources.outputs.docker-image.url):$(params.image-tag)
      volumeMounts:
      - name: cosign-pub
        mountPath: /tmp/cosign.pub
        subPath: cosign.pub
  volumes:
    - name: cosign-pub
      secret:
        secretName: cosign-pub
</code></pre></td></tr></table></div></div><p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥å°†é•œåƒæ„å»ºã€é•œåƒæ‰«æã€é•œåƒç­¾åå’Œé•œåƒéªŒè¯éƒ½é›†æˆåˆ° Tekton CI/CD ä¸­ï¼Œæ¥æ„å»º DevSecOps CI/CDï¼š</p><p><img src=images/image-devsecops.png alt=image-sign-verify></p><p>æ•´ä¸ªæµç¨‹ä¸­ Tekton CI/CD ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>  steps:
    - name: image-build-and-push
      image: gcr.io/kaniko-project/executor:v1.6.0
      env:
        - name: &#34;DOCKER_CONFIG&#34;
          value: &#34;/tekton/home/.docker/&#34;
      command:
        - /kaniko/executor
      args:
        - --dockerfile=$(resources.inputs.source-code.path)/Dockerfile
        - --destination=$(resources.outputs.docker-image.url):$(params.image-tag)
        - --context=$(resources.inputs.source-code.path)
    - name: image-scan
      image: aquasec/trivy
      env:
        - name: TRIVY_USERNAME
          valueFrom:
            secretKeyRef:
              name: dockerhub-user-pass
              key: username
        - name: TRIVY_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dockerhub-user-pass
              key: password
      script: |
        #! /bin/sh
        trivy image --exit-code 1 --severity CRITICAL --vuln-type library  $(resources.outputs.docker-image.url):$(params.image-tag)
    - name: image-singature
      image: bitnami/cosign:latest
      securityContext:
        runAsUser: 0
      args:
        - sign
        - --key
        - /tmp/cosign.key
        - $(resources.outputs.docker-image.url):$(params.image-tag)
      env:
      - name: COSIGN_PASSWORD
        valueFrom:
          secretKeyRef:
            name: cosign-password
            key: cosign-password
      volumeMounts:
      - name: cosign-key
        mountPath: /tmp/cosign.key
        subPath: cosign.key
    - name: image-singature-verification
      image: bitnami/cosign:latest
      args:
        - verify
        - --key
        - /tmp/cosign.pub
        - $(resources.outputs.docker-image.url):$(params.image-tag)
      volumeMounts:
      - name: cosign-pub
        mountPath: /tmp/cosign.pub
        subPath: cosign.pub
  volumes:
    - name: cosign-pub
      secret:
        secretName: cosign-pub
    - name: cosign-key
      secret:
        secretName: cosign-key
</code></pre></td></tr></table></div></div><p>Step è¯´æ˜ï¼š</p><ul><li><p><strong>image-build-and-push</strong>ï¼šç”¨ <code>kaniko</code> æ„å»ºå®¹å™¨é•œåƒï¼Œå®Œæˆä»æºç åˆ°é•œåƒçš„è½¬æ¢ï¼›</p></li><li><p><strong>image-scan</strong>ï¼šç”¨ <code>trivy</code> è¿›è¡Œé•œåƒæ‰«æï¼›</p></li><li><p><strong>image-singature</strong>ï¼šç”¨ <code>cosign sign</code> æ¥å®Œæˆé•œåƒçš„ç­¾åï¼›</p></li><li><p><strong>image-singature-verification</strong>ï¼šç”¨ <code>cosgin verify</code> æ¥é•œåƒç­¾åéªŒè¯ï¼›</p></li></ul><blockquote><p>ç­¾åå’ŒéªŒè¯æ‰€éœ€çš„ public å’Œ private key éƒ½ç”¨ Kubernetes Secret çš„å½¢å¼å­˜å‚¨ï¼Œå¹¶ä»¥ <code>volume</code> çš„å½¢å¼è¿›è¡Œäº†æŒ‚è½½ã€‚</p></blockquote><p>ç”¨ <code>TaskRun</code> è§¦å‘ä¸€ä¸ª <code>Task</code>ï¼Œå¯ä»¥æŸ¥çœ‹ä¸¤è€…çš„çŠ¶æ€ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ tkn -n tekton-cosign tr list
NAME                     STARTED         DURATION   STATUS
build-docker-image-run   3 minutes ago   1 minute   Succeeded
tkn -n tekton-cosign t list
NAME                 DESCRIPTION   AGE
build-docker-image                 4 minutes ago
</code></pre></td></tr></table></div></div><blockquote><p>æ•´ä¸ªæ¼”ç¤ºè¿‡ç¨‹çš„ Tekton ä»£ç åœ¨<a href=https://github.com/majinghe/tekton-demo/tree/main/cosign-demo>è¿™ä¸ª tekton cosign demo GitHub Repo ä¸­</a>ã€‚</p></blockquote><p>å¦‚æœæŸ¥çœ‹ <code>TaskRun</code> çš„å†…å®¹ï¼Œå¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°æ‰€æœ‰ Step çš„çŠ¶æ€ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ tkn -n tekton-cosign tr describe build-docker-image-run
......
ğŸ¦¶ Steps

 NAME                              STATUS
 âˆ™ create-dir-docker-image-vvj5b   Completed
 âˆ™ git-source-source-code-bcxft    Completed
 âˆ™ image-build-and-push            Completed
 âˆ™ image-scan                      Completed
 âˆ™ image-singature                 Completed
 âˆ™ image-singature-verification    Completed
 âˆ™ image-digest-exporter-nmjct     Completed
......
</code></pre></td></tr></table></div></div><p>ä»¥åŠæ•´ä¸ªæ„å»ºè¿‡ç¨‹ä¸­ <code>pod</code> çš„çŠ¶æ€ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl -n tekton-cosign get pods
NAME                         READY   STATUS      RESTARTS   AGE
build-docker-image-run-pod   0/7     Completed   0          4m30s
</code></pre></td></tr></table></div></div><p>å¦‚æœè¦æŸ¥çœ‹æŸä¸€ä¸ªè¿‡ç¨‹ï¼Œç›´æ¥ç”¨ <code>logs -f</code> æŸ¥çœ‹ log å³å¯ã€‚</p><p>å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨ <code>cosign</code> æ¥å®Œæˆé•œåƒçš„ç­¾åå’ŒéªŒè¯ã€ç”¨ <code>trivy</code> æ¥è¿›è¡Œå®¹å™¨é•œåƒæ‰«æï¼Œå¤šç§æ‰‹æ®µåµŒå…¥åˆ° Tekton CI/CD ä¸­æ¥ä¿è¯å®¹å™¨é•œåƒå®‰å…¨ã€‚</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>æ–‡ç« ä½œè€…</span>
<span class=item-content>é©¬æ™¯è´ºï¼ˆå°é©¬å“¥ï¼‰</span></p><p class=copyright-item><span class=item-title>ä¸Šæ¬¡æ›´æ–°</span>
<span class=item-content>2022-05-06</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/security/>Security</a>
<a href=/tags/image/>Image</a>
<a href=/tags/cosign/>Cosign</a></div><nav class=post-nav><a class=next href=/devsecops/tekton-generate-sbom/><span class="next-text nav-default">ç”¨ Tekton æ¥ç”Ÿæˆè½¯ä»¶ç‰©æ–™æ¸…å•ï¼ˆSBOMï¼‰</span>
<span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=devops008@sina.com class="iconfont icon-email" title=email></a><a href=https://github.com/majinghe class="iconfont icon-github" title=github></a><a href=https://majinghe.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>ç”± <a class=hexo-link href=https://gohugo.io>Hugo</a> å¼ºåŠ›é©±åŠ¨</span>
<span class=division>|</span>
<span class=theme-info>ä¸»é¢˜ -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>olOwOlo</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-T0B2C6W2ZH','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>