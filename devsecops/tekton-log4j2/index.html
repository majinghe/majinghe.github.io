<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>用 Tekton 来检测 Apache Log4j 漏洞 - 小马哥的博客</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="马景贺（小马哥）"><meta name=description content="用 Tekton 来扫描检测 log4j 漏洞"><meta name=keywords content="Hugo,theme,even"><meta name=generator content="Hugo 0.79.1 with theme even"><link rel=canonical href=https://majinghe.github.io/Cloud-Native-DevSecOps/devsecops/tekton-log4j2/><link rel=apple-touch-icon sizes=180x180 href=/Cloud-Native-DevSecOps/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/Cloud-Native-DevSecOps/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/Cloud-Native-DevSecOps/favicon-16x16.png><link rel=manifest href=/Cloud-Native-DevSecOps/manifest.json><link rel=mask-icon href=/Cloud-Native-DevSecOps/safari-pinned-tab.svg color=#5bbad5><link href=/Cloud-Native-DevSecOps/sass/main.min.c7bc1becf36bcf6a9ebd25d2947e43a2eb745ddb0c9a32b43126fd7fa460c351.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="用 Tekton 来检测 Apache Log4j 漏洞"><meta property="og:description" content="用 Tekton 来扫描检测 log4j 漏洞"><meta property="og:type" content="article"><meta property="og:url" content="https://majinghe.github.io/Cloud-Native-DevSecOps/devsecops/tekton-log4j2/"><meta property="article:published_time" content="2021-12-25T13:05:42+08:00"><meta property="article:modified_time" content="2021-12-25T13:05:42+08:00"><meta itemprop=name content="用 Tekton 来检测 Apache Log4j 漏洞"><meta itemprop=description content="用 Tekton 来扫描检测 log4j 漏洞"><meta itemprop=datePublished content="2021-12-25T13:05:42+08:00"><meta itemprop=dateModified content="2021-12-25T13:05:42+08:00"><meta itemprop=wordCount content="3738"><meta itemprop=keywords content="Software Supply Chain Security,Tekton,Log4j2,"><meta name=twitter:card content="summary"><meta name=twitter:title content="用 Tekton 来检测 Apache Log4j 漏洞"><meta name=twitter:description content="用 Tekton 来扫描检测 log4j 漏洞"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/Cloud-Native-DevSecOps/ class=logo>小马哥</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/Cloud-Native-DevSecOps/cloud-native><li class=mobile-menu-item>Cloud Native</li></a><a href=/Cloud-Native-DevSecOps/devsecops><li class=mobile-menu-item>DevSecOps</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/Cloud-Native-DevSecOps/ class=logo>小马哥</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/Cloud-Native-DevSecOps/cloud-native>Cloud Native</a></li><li class=menu-item><a class=menu-item-link href=/Cloud-Native-DevSecOps/devsecops>DevSecOps</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>用 Tekton 来检测 Apache Log4j 漏洞</h1><div class=post-meta><span class=post-time>2021-12-25</span><div class=post-category><a href=/Cloud-Native-DevSecOps/categories/security/>Security</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#关于-apache-log4j-漏洞>关于 Apache Log4j 漏洞</a></li><li><a href=#tekton>Tekton</a></li><li><a href=#用-tekton-检测-log4j-漏洞>用 Tekton 检测 log4j 漏洞</a><ul><li><a href=#用-trivy-做镜像扫描>用 Trivy 做镜像扫描</a></li><li><a href=#log4j-demo-构建>log4j Demo 构建</a></li><li><a href=#tekton-cicd-扫描-log4j-漏洞>Tekton CI/CD 扫描 log4j 漏洞</a></li></ul></li><li><a href=#安全启示录>安全启示录</a></li></ul></li></ul></nav></div></div><div class=post-content><p align=center><img src=images/banner.png alt="Tekton Scan Log4j2 Vulerability"></p><h2 id=关于-apache-log4j-漏洞>关于 Apache Log4j 漏洞</h2><p>log4j 漏洞在 2021 年的最后一个月掀起了很大的风波，由于 log4j 被广泛应用于 java 项目中，因此众多 java 小伙伴也是在加班加点应对。由于 log4j 在不断的爆发出新的漏洞，从 2.15 版本到 2.16 版本，目前最新的是 2.17 版本，关于 log4j 更多的详情以及修复手段，建议查看 <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228">CVE 官网</a>或者 <a href=https://nvd.nist.gov/vuln/detail/CVE-2021-44228>NVD 官网</a>。</p><h2 id=tekton>Tekton</h2><p><a href=https://github.com/tektoncd>Tekton</a>是 Google 开源的一款灵活强大的 CI/CD 系统。原理图如下：</p><p><img src=images/tekton-arch.png alt=tekton-arch></p><p>Tekton 大体可以分为两大块：<strong>Event Handler</strong> & <strong>Pipeline Handler</strong>。Event Handler 主要是接受 SCM 系统的事件消息（如代码变更），然后做一些处理，获取必要的信息（代码提交者、提交内容等），然后把这些内容当作输入（Input）传递到 Pipeline Handler 部分，Pipeline Handler 会根据用于自定义的流程（如完成源码到镜像的转换）来完成整个 CI/CD 构建。</p><p>对于 Pipeline Handler 部分，有几个概念需要了解一下：</p><ul><li><p><code>Step</code>：<code>Step</code> 是 Tekton 最基本的操作单元，每一个 <code>Step</code> 就是用特定的构建工具来用特定的输入（Input）生成特定输出（Output）的过程，上一个 <code>Step</code> 的输出可以作为下一个 <code>Step</code> 的输入。<code>Step</code> 是在由用户提供的容器镜像拉起的容器里面完成工作的；</p></li><li><p><code>Task</code>：<code>Task</code> 是一系列 <code>Step</code> 的有序集合。<code>Task</code> 是在 Kubernetes pod 里面完成工作的；而 <code>Step</code> 是 pod 的单个容器中完成工作的；</p></li><li><p><code>TaskRun</code>：<code>TaskRun</code> 是 <code>Task</code> 的具体执行。每次创建一个 <code>TaskRun</code> 就会有一个指定的 <code>Task</code> 开始运行。<code>TaskRun</code> 可以单独运行，也可以被嵌入到 <code>PipelineRun</code> 中；</p></li><li><p><code>Pipeline</code>：<code>Pipeline</code> 是一系列 <code>Task</code> 的有序集合。Tekton 会收集所有的 tasks，将它们链接成一个有向无环图（directed acyclic graph，即 DAG），然后按顺序执行。<code>Pipeline</code> 的执行会生成一系列 pod。</p></li><li><p><code>PipelineRun</code>：<code>PipelineRun</code> 是 <code>Pipeline</code> 的具体执行。每次创建一个 <code>PipelineRun</code> 就会有一个指定的 <code>Pipeline</code> 开始运行。</p></li><li><p><code>PipelineResource</code>：<code>PipelineResource</code>，主要用来定义 <code>Step</code> 需要的输入（Input）以及相应的输出（Output）。</p></li></ul><h2 id=用-tekton-检测-log4j-漏洞>用 Tekton 检测 log4j 漏洞</h2><h3 id=用-trivy-做镜像扫描>用 Trivy 做镜像扫描</h3><p><a href=https://github.com/aquasecurity/trivy>Trivy</a>是一款简单易用的漏洞扫描开源工具，可以对容器镜像、文件系统、Git Repo 及配置文件进行漏洞扫描。其扫描的大致原理是：<strong>分析镜像（包括 OS，library 等）特征，然后将特征与数据库中进行比对，从而识别出具有漏洞的内容，出具漏洞报告</strong>。</p><h4 id=trivy-安装>Trivy 安装</h4><p>Trivy 的安装方式灵活多样（安装包、docker、helm 都可以），使用方便，详情可以查看<a href=https://aquasecurity.github.io/trivy/v0.22.0/getting-started/installation/>Trivy 官网安装指南</a>。本文以 macOS 为例来简单说明：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ brew install aquasecurity/trivy/trivy
</code></pre></td></tr></table></div></div><p>可以用 <code>--help</code> 或 <code>--version</code> 来验证安装是否成功：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ trivy --version
Version: 0.19.2
</code></pre></td></tr></table></div></div><h4 id=trivy-使用>Trivy 使用</h4><p>用 <code>trivy image + image_name</code> 即可开启镜像扫描，如以 <code>alpine:3.10</code> 为例说明使用方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ trivy image alpine:3.10
2021-12-26T13:26:17.747+0800	INFO	Detected OS: alpine
2021-12-26T13:26:17.747+0800	INFO	Detecting Alpine vulnerabilities...
2021-12-26T13:26:17.749+0800	INFO	Number of language-specific files: 0
2021-12-26T13:26:17.749+0800	WARN	This OS version is no longer supported by the distribution: alpine 3.10.9
2021-12-26T13:26:17.749+0800	WARN	The vulnerability detection may be insufficient because security updates are not provided

alpine:3.10 (alpine 3.10.9)
===========================
Total: 1 (UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: 0, CRITICAL: 1)

+-----------+------------------+----------+-------------------+---------------+---------------------------------------+
|  LIBRARY  | VULNERABILITY ID | SEVERITY | INSTALLED VERSION | FIXED VERSION |                 TITLE                 |
+-----------+------------------+----------+-------------------+---------------+---------------------------------------+
| apk-tools | CVE-2021-36159   | CRITICAL | 2.10.6-r0         | 2.10.7-r0     | libfetch before 2021-07-26, as        |
|           |                  |          |                   |               | used in apk-tools, xbps, and          |
|           |                  |          |                   |               | other products, mishandles...         |
|           |                  |          |                   |               | --&gt;avd.aquasec.com/nvd/cve-2021-36159 |
+-----------+------------------+----------+-------------------+---------------+---------------------------------------+
</code></pre></td></tr></table></div></div><p>可以看到扫描出了一个高危漏洞 <strong><code>CVE-2021-36159</code></strong>。</p><h3 id=log4j-demo-构建>log4j Demo 构建</h3><p>为了用 Trivy 扫描 log4j 漏洞，先构建一个用 maven 进行构建的 java 项目，简单的输出 <code>Hello World</code>，仅仅作为演示用。代码 Repo 在<a href=https://github.com/majinghe/java-maven-hello-world-4-log4j2>这儿</a>。目录结构为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ tree
.
├── Dockerfile
├── LICENSE
├── README.md
├── pom.xml
└── src
    └── main
        └── java
            └── com
                └── example
                    └── hello
                        └── Hello.java
</code></pre></td></tr></table></div></div><p><code>Hello.java</code> 的内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>com</span><span class=p>.</span><span class=nx>example</span><span class=p>.</span><span class=nx>hello</span><span class=p>;</span>

<span class=kn>import</span> <span class=nx>org</span><span class=p>.</span><span class=nx>apache</span><span class=p>.</span><span class=nx>logging</span><span class=p>.</span><span class=nx>log4j</span><span class=p>.</span><span class=nx>Logger</span><span class=p>;</span>
<span class=kn>import</span> <span class=nx>org</span><span class=p>.</span><span class=nx>apache</span><span class=p>.</span><span class=nx>logging</span><span class=p>.</span><span class=nx>log4j</span><span class=p>.</span><span class=nx>LogManager</span><span class=p>;</span>

<span class=nx>public</span> <span class=nx>class</span> <span class=nx>Hello</span> <span class=p>{</span>

	<span class=nx>private</span> <span class=nx>static</span> <span class=nx>Logger</span> <span class=nx>log</span> <span class=p>=</span> <span class=nx>LogManager</span><span class=p>.</span><span class=nf>getLogger</span><span class=p>(</span><span class=nx>Hello</span><span class=p>.</span><span class=nx>class</span><span class=p>.</span><span class=nf>getClass</span><span class=p>());</span>

	<span class=nx>public</span> <span class=nx>static</span> <span class=nx>void</span> <span class=nf>main</span><span class=p>(</span><span class=nx>String</span> <span class=p>[]</span> <span class=nx>args</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>log</span><span class=p>.</span><span class=nf>info</span><span class=p>(</span><span class=s>&#34;Hello World!!!&#34;</span><span class=p>);</span>
	<span class=p>}</span>

<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><code>pom.xml</code> 文件中与 <code>log4j</code> 相关的依赖描述如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
    &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;
    &lt;version&gt;2.11.0&lt;/version&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre></td></tr></table></div></div><p>Dockerfile 的内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=nx>FROM</span> <span class=nx>maven</span><span class=p>:</span><span class=mf>3.8.4</span><span class=o>-</span><span class=nx>jdk</span><span class=o>-</span><span class=mi>11</span><span class=o>-</span><span class=nx>slim</span>

<span class=nx>COPY</span> <span class=p>.</span> <span class=o>/</span><span class=nx>tmp</span>

<span class=nx>WORKDIR</span> <span class=o>/</span><span class=nx>tmp</span><span class=o>/</span>

<span class=nx>RUN</span> <span class=nx>mvn</span> <span class=kn>package</span> <span class=o>-</span><span class=nx>Dmaven</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>skip</span><span class=p>=</span><span class=kc>true</span>
</code></pre></td></tr></table></div></div><p>接下来就可以用 docker 来构建一个镜像：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ docker build -t dllhb/tekton-scan-log4j2:0.0.1 .
</code></pre></td></tr></table></div></div><p>用 Trivy 来扫描：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ trivy image --severity CRITICAL --vuln-type library dllhb/tekton-scan-log4j2:1.0.0
2021-12-26T13:56:14.307+0800	INFO	Number of language-specific files: 148
2021-12-26T13:56:14.309+0800	INFO	Detecting jar vulnerabilities...

root/.m2/repository/org/apache/logging/log4j/log4j-api/2.11.0/log4j-api-2.11.0.jar (jar)
========================================================================================
Total: 2 (CRITICAL: 2)

+------------------------------------+------------------+----------+-------------------+---------------+---------------------------------------+
|              LIBRARY               | VULNERABILITY ID | SEVERITY | INSTALLED VERSION | FIXED VERSION |                 TITLE                 |
+------------------------------------+------------------+----------+-------------------+---------------+---------------------------------------+
| org.apache.logging.log4j:log4j-api | CVE-2021-44228   | CRITICAL | 2.11.0            | 2.15.0        | log4j-core: Remote code execution     |
|                                    |                  |          |                   |               | in Log4j 2.x when logs contain        |
|                                    |                  |          |                   |               | an attacker-controlled...             |
|                                    |                  |          |                   |               | --&gt;avd.aquasec.com/nvd/cve-2021-44228 |
+                                    +------------------+          +                   +---------------+---------------------------------------+
|                                    | CVE-2021-45046   |          |                   | 2.16.0        | log4j-core: DoS in log4j 2.x          |
|                                    |                  |          |                   |               | with thread context message           |
|                                    |                  |          |                   |               | pattern and context...                |
|                                    |                  |          |                   |               | --&gt;avd.aquasec.com/nvd/cve-2021-45046 |
+------------------------------------+------------------+----------+-------------------+---------------+---------------------------------------+

root/.m2/repository/org/apache/logging/log4j/log4j-core/2.11.0/log4j-core-2.11.0.jar (jar)
==========================================================================================
Total: 2 (CRITICAL: 2)

+-------------------------------------+------------------+----------+-------------------+---------------+---------------------------------------+
|               LIBRARY               | VULNERABILITY ID | SEVERITY | INSTALLED VERSION | FIXED VERSION |                 TITLE                 |
+-------------------------------------+------------------+----------+-------------------+---------------+---------------------------------------+
| org.apache.logging.log4j:log4j-core | CVE-2021-44228   | CRITICAL | 2.11.0            | 2.15.0        | log4j-core: Remote code execution     |
|                                     |                  |          |                   |               | in Log4j 2.x when logs contain        |
|                                     |                  |          |                   |               | an attacker-controlled...             |
|                                     |                  |          |                   |               | --&gt;avd.aquasec.com/nvd/cve-2021-44228 |
+                                     +------------------+          +                   +---------------+---------------------------------------+
|                                     | CVE-2021-45046   |          |                   | 2.16.0        | log4j-core: DoS in log4j 2.x          |
|                                     |                  |          |                   |               | with thread context message           |
|                                     |                  |          |                   |               | pattern and context...                |
|                                     |                  |          |                   |               | --&gt;avd.aquasec.com/nvd/cve-2021-45046 |
+-------------------------------------+------------------+----------+-------------------+---------------+---------------------------------------+
.... 只截取与 log4j 有关的信息.....
</code></pre></td></tr></table></div></div><p>可以看到扫描出了与 log4j 有关的漏洞：<strong><code>CVE-2021-44228</code></strong>、<strong><code>CVE-2021-45046</code></strong>。接下来将 Trivy 和 Tekton 进行结合，将漏洞扫描嵌入到 Tekton CI/CD 中。</p><blockquote><p>上述 Demo 代码只为扫描 log4j 而构建。</p></blockquote><h3 id=tekton-cicd-扫描-log4j-漏洞>Tekton CI/CD 扫描 log4j 漏洞</h3><p>Tekton 的 Demo Repo 在<a href=https://github.com/majinghe/tekton-chains-demo>这儿</a>。代码目录结构为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ tree
.
├── LICENSE
├── README.md
├── pipelineresource.yaml
├── sa.yaml
├── secret-credentials.yaml
├── task.yaml
└── taskrun.yaml
</code></pre></td></tr></table></div></div><p>其中：</p><ul><li><strong><code>pipelineresource.yaml</code></strong>：指定了 CI/CD 构建时的 Input（源码地址，即上述 java 的 GitHub 地址）；Output（dockerhub 地址）；</li><li><strong><code>sa.yaml</code></strong>：ServiceAccount 信息，里面关联了登陆 GitHub 以及 Dockerhub 的 <code>Secret</code> 信息；</li><li><strong><code>secret-credentials.yaml</code></strong>：登陆 GitHub 及 Dockerhub 时，所需要的用户名密码信息；</li><li><strong><code>task.yaml</code></strong>：<code>task</code> 定义信息；</li><li><strong><code>taskrun.yaml</code></strong>：<code>taskrun</code> 定义信息；</li></ul><p>先创建一个 namespace，接着用 <code>kubectl apply</code> 命令创建上述的资源即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl create ns tekton-scan-log4j2
namespace/tekton-scan-log4j2 created

$ kubectl -n tekton-scan-log4j2 apply -f pipelineresource.yaml
pipelineresource.tekton.dev/source-code created
pipelineresource.tekton.dev/docker-image created

$ kubectl -n tekton-scan-log4j2 apply -f secret-credentials.yaml
secret/dockerhub-user-pass created
secret/github-user-pass created
secret/ssh-key created

$ kubectl -n tekton-scan-log4j2 apply -f sa.yaml
serviceaccount/tekton-service created
</code></pre></td></tr></table></div></div><p>接下来就是创建 <code>task</code> 以及 <code>taskrun</code> 的重头戏了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl -n tekton-scan-log4j2 apply -f task.yaml
task.tekton.dev/build-docker-image created

$ kubectl -n tekton-scan-log4j2 apply -f taskrun.yaml
taskrun.tekton.dev/build-docker-image-run created
</code></pre></td></tr></table></div></div><p>查看创建的 <code>task</code> 以及 <code>taskrun</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ tkn -n tekton-scan-log4j2 t list
NAME                 DESCRIPTION   AGE
build-docker-image                 55 seconds ago

tkn -n tekton-scan-log4j2 tr list
NAME                     STARTED          DURATION   STATUS
build-docker-image-run   49 seconds ago   ---        Running
</code></pre></td></tr></table></div></div><p>可以看到 <code>task</code>、<code>taskrun</code> 已经被创建出来并且在执行了。由于 <code>taskrun</code> 会创建一个 pod 来完成整个构建，所以可以在 tekton-scan-log4j2 namespace 下面查看 pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl -n tekton-scan-log4j2 get pods -w
NAME                         READY   STATUS    RESTARTS   AGE
build-docker-image-run-pod   0/5     Pending   0          0s
build-docker-image-run-pod   0/5     Pending   0          0s
build-docker-image-run-pod   0/5     Init:0/2   0          0s
build-docker-image-run-pod   0/5     Init:1/2   0          2s
build-docker-image-run-pod   0/5     PodInitializing   0          3s
build-docker-image-run-pod   5/5     Running           0          13s
build-docker-image-run-pod   5/5     Running           0          13s
build-docker-image-run-pod   4/5     NotReady          0          15s
build-docker-image-run-pod   3/5     NotReady          0          21s
</code></pre></td></tr></table></div></div><p>可以看到有 pod 产生并且正在执行 CI/CD。</p><p>当 pod 状态为 <code>Completed</code> 时，证明 <code>TaskRun</code> 执行结束，是否成功，需要再次检查：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ tkn -n tekton-scan-log4j2 tr list
NAME                     STARTED          DURATION     STATUS
build-docker-image-run   54 minutes ago   16 minutes   Succeeded
</code></pre></td></tr></table></div></div><p>由于 <code>TaskRun</code> 的状态是 <code>Succeeded</code>，证明此次 <code>TaskRun</code> 执行成功。可以用 <code>kubectl logs -f</code> 查看任意执行阶段的 log，如查看用 Trivy 扫描 log4j 漏洞的 log：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl -n tekton-scan-log4j2 logs -f build-docker-image-run-pod -c step-image-scan
2021-12-26T10:21:40.676Z	INFO	Need to update DB
2021-12-26T10:21:40.676Z	INFO	Downloading DB...
2021-12-26T10:23:47.667Z	INFO	Number of language-specific files: 1
2021-12-26T10:23:47.667Z	INFO	Detecting jar vulnerabilities...

Java (jar)
==========
Total: 7 (CRITICAL: 7)

+-------------------------------------+------------------+----------+-------------------+---------------+-----------------------------------------+
|               LIBRARY               | VULNERABILITY ID | SEVERITY | INSTALLED VERSION | FIXED VERSION |                  TITLE                  |
+-------------------------------------+------------------+----------+-------------------+---------------+-----------------------------------------+
| org.apache.logging.log4j:log4j-api  | CVE-2021-44228   | CRITICAL | 2.11.0            | 2.15.0        | log4j-core: Remote code execution       |
|                                     |                  |          |                   |               | in Log4j 2.x when logs contain          |
|                                     |                  |          |                   |               | an attacker-controlled...               |
|                                     |                  |          |                   |               | --&gt;avd.aquasec.com/nvd/cve-2021-44228   |
+                                     +------------------+          +                   +---------------+-----------------------------------------+
|                                     | CVE-2021-45046   |          |                   | 2.16.0        | log4j-core: DoS in log4j 2.x            |
|                                     |                  |          |                   |               | with thread context message             |
|                                     |                  |          |                   |               | pattern and context...                  |
|                                     |                  |          |                   |               | --&gt;avd.aquasec.com/nvd/cve-2021-45046   |
+-------------------------------------+------------------+          +                   +---------------+-----------------------------------------+
| org.apache.logging.log4j:log4j-core | CVE-2021-44228   |          |                   | 2.15.0        | log4j-core: Remote code execution       |
|                                     |                  |          |                   |               | in Log4j 2.x when logs contain          |
|                                     |                  |          |                   |               | an attacker-controlled...               |
|                                     |                  |          |                   |               | --&gt;avd.aquasec.com/nvd/cve-2021-44228   |
+                                     +------------------+          +                   +---------------+-----------------------------------------+
|                                     | CVE-2021-45046   |          |                   | 2.16.0        | log4j-core: DoS in log4j 2.x            |
|                                     |                  |          |                   |               | with thread context message             |
|                                     |                  |          |                   |               | pattern and context...                  |
|                                     |                  |          |                   |               | --&gt;avd.aquasec.com/nvd/cve-2021-45046   |
+-------------------------------------+------------------+          +-------------------+---------------+----------------------

.... too long, just find the vulnerability info related with log4j ....
</code></pre></td></tr></table></div></div><p>可以看到 CI/CD 的扫描阶段成功扫描出 log4j 漏洞，ID 为 <strong><code>CVE-2021-44228</code></strong>、<strong><code>CVE-2021-45046</code></strong>。</p><p>但是，在正常的 CI/CD Pipeline 中，有一个规则：<strong>CI/CD Pipeline 中，任意阶段发生错误，都应该立即终止此次 Pipeline 终止，以防止有问题的代码被合并到主分支</strong>。上述 CI/CD 扫描出了 log4j 漏洞，但是结果是成功的，下面在 Trivy 扫描的时候做一些修改，以避免这种情况：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>trivy image --exit-code 1
</code></pre></td></tr></table></div></div><p><strong><code>--exit-code</code></strong> 表示当检测出指定级别的漏洞时候，返回非 0 值，从而可以终止后续的流程。继续触发 <code>TaskRun</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ tkn -n tekton-scan-log4j2 tr list
NAME                     STARTED          DURATION     STATUS
build-docker-image-run   53 minutes ago   41 minutes   Failed
</code></pre></td></tr></table></div></div><p>可以看到此次 <code>TaskRn</code> 的状态为 <strong>Failed</strong>，可以 describe 一下此 <code>TaskRun</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ tkn -n tekton-scan-log4j2 tr describe build-docker-image-run
...... 截取主要部分 .....
 NAME                              STATUS
 ∙ create-dir-docker-image-4cdrq   Completed
 ∙ git-source-source-code-rzqsr    Completed
 ∙ image-build-and-push            Completed
 ∙ image-scan                      Error
 ∙ image-digest-exporter-q68zx     Error
</code></pre></td></tr></table></div></div><p>可以看到拉取代码，构建镜像相关的 Step 都是成功的，而 <code>image-scan</code> Step 是 <code>Error</code> 状态，查看此 Step 的 log 可以看到与上面相同的结果，证明扫描成功，因为扫描除了 log4j 漏洞，所以终止了此次 Pipeline，后续的 Step 都没有执行。证明 <code>--exit-code 1</code> 生效。</p><p>上述就是用 Tekton 结合 Trivy 来扫描 log4j 漏洞的整个过程。</p><h2 id=安全启示录>安全启示录</h2><p>log4j 漏洞给我们带来了很多思考：</p><ul><li><strong>开源吞噬世界</strong>已然发生，此次漏洞事件再次证实了这一点。开源软件是现代数字化社会的基石。开源和开源安全都值得更多的关注。</li><li>漏洞不可怕，漏洞伴随着软件的诞生而诞生。发现漏洞时，需要及时在漏洞官网（CVE 或 NVD）来查看跟踪详细动态，找到解决方案，及时修复即可。</li><li>将相关安全检测手段（SAST、DAST、Image Scan 等）融入到 CI/CD 中，做到<strong>安全左移 && 安全检测持续自动化</strong>，打造端到端的 DevSecOps CI/CD。</li><li>开源软件供应链安全需要提高优先级。此次 log4j 漏洞是一个典型的开源软件供应链安全案例。log4j 作为 Upstream，成为了众多 Downstream 软件的必要组建，Upstream 有安全漏洞，影响到了一大波 Downstream。为了更够在安全漏洞发生的时候，及时快速修复并将软件及时更新来避免漏洞带来的影响。而这就需要构建完整的开源软件供应链安全，需要所有组织、个人的共同参与，足够的透明化能够助力安全屏障的建立。关于开源软件供应链安全的详细介绍，可以查看前面的博文<a href=https://majinghe.github.io/Cloud-Native-DevSecOps/devsecops/sbom/>从 Anchore 软件供应链安全报告深挖 SBOM & SPDX</a>。</li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>马景贺（小马哥）</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-12-25</span></p></div><footer class=post-footer><div class=post-tags><a href=/Cloud-Native-DevSecOps/tags/software-supply-chain-security/>Software Supply Chain Security</a>
<a href=/Cloud-Native-DevSecOps/tags/tekton/>Tekton</a>
<a href=/Cloud-Native-DevSecOps/tags/log4j2/>Log4j2</a></div><nav class=post-nav><a class=prev href=/Cloud-Native-DevSecOps/devsecops/sbom-report/><i class="iconfont icon-left"></i><span class="prev-text nav-default">《软件物料清单与网络安全可读性》调研报告解读</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/Cloud-Native-DevSecOps/devsecops/sbom/><span class="next-text nav-default">从 Anchore 软件供应链安全报告深挖 SBOM & SPDX</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=devops008@sina.com class="iconfont icon-email" title=email></a><a href=https://github.com/majinghe class="iconfont icon-github" title=github></a><a href=https://majinghe.github.io/Cloud-Native-DevSecOps/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>olOwOlo</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/Cloud-Native-DevSecOps/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js></script></body></html>